<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nebula Portable</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #050505;
            color: #fff;
            font-family: sans-serif;
            overflow-x: hidden;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            color: #6366f1;
        }

        #search {
            padding: 10px;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            border-radius: 5px;
            width: 200px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        .card {
            background: #111;
            border: 1px solid #222;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: .2s;
            text-align: center;
        }

        .card:hover {
            transform: translateY(-3px);
            border-color: #6366f1;
        }

        .card-img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            background: #000;
        }

        .card-emoji {
            font-size: 40px;
            line-height: 100px;
            height: 100px;
            background: #151515;
            display: block;
        }

        .card-info {
            padding: 10px;
        }

        .card h3 {
            margin: 0;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card p {
            font-size: 11px;
            color: #888;
            margin: 5px 0 0;
        }

        #game-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            z-index: 999;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }

        #game-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: rgba(0, 0, 0, .8);
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
        }

        .back-btn {
            background: #6366f1;
            color: #fff;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
        }

        .back-btn:hover {
            background: #4f46e5;
        }

        #game-title {
            margin-left: 15px;
            font-weight: 700;
        }
    </style>
</head>

<body>

    <header>
        <h1>Nebula</h1>
        <input type="text" id="search" placeholder="Search..." onkeyup="filterGames()">
    </header>

    <div id="status">Loading Library...</div>
    <div id="grid" class="grid"></div>

    <div id="game-view">
        <div id="game-bar">
            <button class="back-btn" onclick="closeGame()">EXIT</button>
            <span id="game-title">Game Title</span>
        </div>
        <iframe id="frame" allowfullscreen></iframe>
    </div>

    <script>
        const REPO = "https://cdn.jsdelivr.net/gh/tracerip/nebula@refs/heads/v2";
        let library = [];
        let currentList = [];

        // Load both JSON files and merge them
        (async function () {
            try {
                const urls = ["/g/index.json", "/a/index.json"];
                const results = await Promise.all(urls.map(u => fetch(REPO + u).then(r => {
                    if (!r.ok) throw new Error(u + " not found");
                    return r.json();
                })));
                // Combine all games into one array
                library = results.flat();
                document.getElementById("status").style.display = "none";
                sortLib(library);
                render(library);
            } catch (e) {
                document.getElementById("status").innerText = "Error loading library: " + e.message;
                console.error(e);
            }
        })();

        function render(list) {
            const grid = document.getElementById("grid");
            grid.innerHTML = "";
            currentList = list;

            list.forEach(item => {
                const el = document.createElement("div");
                el.className = "card";

                const img = item.thumbnail
                    ? `<img src="${REPO}/${item.thumbnail}" class="card-img" loading="lazy">`
                    : `<span class="card-emoji">ðŸŽ®</span>`;

                el.innerHTML = `
      ${img}
      <div class="card-info">
        <h3>${item.title}</h3>
        <p>${item.tags?.join(", ") || "Click to Play"}</p>
      </div>
    `;

                el.onclick = () => {
                    launchRaw(
                        item.title,
                        REPO + "/" + item.path,
                        REPO + "/" + item.path.replace(/\/[^/]+$/, "/")
                    );
                };

                grid.appendChild(el);
            });
        }

        async function launchRaw(titleStr, fileUrl, baseUrl) {
            const view = document.getElementById("game-view");
            const frame = document.getElementById("frame");
            const title = document.getElementById("game-title");
            title.innerText = "Loading " + titleStr + "...";
            view.style.display = "block";

            try {
                const response = await fetch(fileUrl);
                if (!response.ok) throw new Error("File not found");

                let html = await response.text();
                if (html.indexOf("<base") === -1) {
                    html = html.replace("<head>", `<head><base href="${baseUrl}">`);
                }

                const doc = frame.contentWindow.document;
                doc.open();
                doc.write(html);
                doc.close();
                title.innerText = titleStr;
            } catch (e) {
                title.innerText = "Error Loading";
                frame.contentWindow.document.body.innerHTML = `<div style='color:white;font-family:sans-serif;padding:20px'><h2>Error loading content</h2><p>${e.message}</p></div>`;
            }
        }

        function closeGame() {
            const view = document.getElementById("game-view");
            const frame = document.getElementById("frame");
            view.style.display = "none";
            frame.src = "about:blank";
        }

        function filterGames() {
            const term = document.getElementById("search").value.toLowerCase();
            if (!term) return render(library);

            render(
                library.filter(g =>
                    g.title.toLowerCase().includes(term) ||
                    g.tags?.some(t => t.toLowerCase().includes(term))
                )
            );
        }

        function sortLib(lst) {
            lst.sort((a, b) => a.title.localeCompare(b.title));
        }
    </script>

</body>

</html>